{"ast":null,"code":"import { useContext, useEffect } from \"react\";\nimport MapContext from \"../Map/MapContext\";\nimport OLVectorLayer from \"ol/layer/Vector\";\nimport { Vector as VectorSource } from 'ol/source';\nimport { transformExtent } from 'ol/proj';\nimport { getArea } from 'ol/sphere';\nimport OSMXML from 'ol/format/OSMXML';\nimport { bbox as bboxStrategy } from 'ol/loadingstrategy';\nimport { toLonLat } from 'ol/proj';\nimport { useSelector, useDispatch } from 'react-redux';\nimport { addBuilding, removeBuilding } from '../redux/actions/buildingActions';\nimport proj4 from \"proj4\";\n\nconst VectorLayer = ({\n  defaultStyle,\n  highlightStyle,\n  renderZoom,\n  centerSetter,\n  zIndex = 1\n}) => {\n  const {\n    map\n  } = useContext(MapContext);\n  const buildings = useSelector(state => state.buildings);\n  const dispatch = useDispatch();\n  useEffect(() => {\n    if (!map) return;\n    let source = new VectorSource({\n      format: new OSMXML(),\n      loader: function (extent, resolution, projection) {\n        var epsg4326Extent = transformExtent(extent, projection, 'EPSG:4326');\n        var client = new XMLHttpRequest();\n        client.open('POST', 'https://overpass-api.de/api/interpreter');\n        client.addEventListener('load', function () {\n          var features = new OSMXML().readFeatures(client.responseText, {\n            featureProjection: map.getView().getProjection()\n          });\n          source.addFeatures(features);\n          reloadSelectedItems(source);\n        });\n        var extended_load_percentage = 0.02;\n        var stringExtent = epsg4326Extent[1] - epsg4326Extent[1] * extended_load_percentage + ',' + (epsg4326Extent[0] * extended_load_percentage + epsg4326Extent[0]) + ',' + (epsg4326Extent[3] * extended_load_percentage + epsg4326Extent[3]) + ',' + (epsg4326Extent[2] - epsg4326Extent[2] * extended_load_percentage);\n        var query = \"(way[building](\" + stringExtent + \");); out meta; >; out meta qt;\";\n        client.send(query);\n      },\n      strategy: bboxStrategy\n    });\n    let vectorLayer = new OLVectorLayer({\n      source: source,\n      style: defaultStyle,\n      minZoom: renderZoom\n    });\n    map.addLayer(vectorLayer);\n    vectorLayer.setZIndex(zIndex);\n    return () => {\n      if (map) {\n        map.removeLayer(vectorLayer);\n      }\n    };\n  }, [map]);\n  useEffect(() => {\n    if (!map) return;\n    map.addEventListener('singleclick', modifyBuildingListListener);\n    return () => {\n      if (map) {\n        map.removeEventListener('singleclick', modifyBuildingListListener);\n      }\n    };\n  }, [map, buildings]);\n\n  function reloadSelectedItems(source) {\n    Object.keys(buildings).map((dictkey, index) => source.getFeatureById(getOriginalId(dictkey)).setStyle(highlightStyle));\n  }\n\n  function getOriginalId(string) {\n    return string.replace(\"Building \", \"\");\n  }\n\n  function getPolygonCoordinates(coordinates) {\n    var newCoordinates = [];\n    coordinates.map(element => {\n      debugger;\n      var latloncoordinates = proj4('EPSG:3857', 'WGS84', [element[1], element[0]]); //var latloncoordinates = [element[1], element[0]]\n\n      newCoordinates.push(latloncoordinates);\n    });\n    return newCoordinates;\n  }\n\n  function modifyBuildingListListener(e) {\n    map.forEachFeatureAtPixel(e.pixel, function (f) {\n      var keys = Object.keys(buildings);\n      var buildingOlId = \"Building \" + f.getId();\n      var selIndex = keys.indexOf(buildingOlId);\n      centerSetter(toLonLat(map.getView().getCenter()));\n      debugger;\n\n      if (selIndex < 0) {\n        var coordinates = f.getGeometry().getInteriorPoint().getCoordinates();\n        var lonLatCoordinates = toLonLat([coordinates[0], coordinates[1]]);\n        var latitude = lonLatCoordinates[0];\n        var longitude = lonLatCoordinates[1];\n        var area = getArea(f.getGeometry()).toFixed(2);\n        var polygonCoordinates = getPolygonCoordinates(f.getGeometry().getCoordinates()[0]);\n        dispatch(addBuilding(buildingOlId, latitude, longitude, area, polygonCoordinates));\n        f.setStyle(highlightStyle);\n      } else {\n        dispatch(removeBuilding(buildingOlId));\n        f.setStyle(defaultStyle);\n      }\n    });\n  }\n\n  return null;\n};\n\nexport default VectorLayer;","map":{"version":3,"sources":["/home/enrique/projects/TFG/src/Layers/VectorLayer.js"],"names":["useContext","useEffect","MapContext","OLVectorLayer","Vector","VectorSource","transformExtent","getArea","OSMXML","bbox","bboxStrategy","toLonLat","useSelector","useDispatch","addBuilding","removeBuilding","proj4","VectorLayer","defaultStyle","highlightStyle","renderZoom","centerSetter","zIndex","map","buildings","state","dispatch","source","format","loader","extent","resolution","projection","epsg4326Extent","client","XMLHttpRequest","open","addEventListener","features","readFeatures","responseText","featureProjection","getView","getProjection","addFeatures","reloadSelectedItems","extended_load_percentage","stringExtent","query","send","strategy","vectorLayer","style","minZoom","addLayer","setZIndex","removeLayer","modifyBuildingListListener","removeEventListener","Object","keys","dictkey","index","getFeatureById","getOriginalId","setStyle","string","replace","getPolygonCoordinates","coordinates","newCoordinates","element","latloncoordinates","push","e","forEachFeatureAtPixel","pixel","f","buildingOlId","getId","selIndex","indexOf","getCenter","getGeometry","getInteriorPoint","getCoordinates","lonLatCoordinates","latitude","longitude","area","toFixed","polygonCoordinates"],"mappings":"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","sourcesContent":["import { useContext, useEffect } from \"react\";\nimport MapContext from \"../Map/MapContext\";\nimport OLVectorLayer from \"ol/layer/Vector\";\nimport { Vector as VectorSource } from 'ol/source';\nimport { transformExtent } from 'ol/proj';\nimport { getArea } from 'ol/sphere';\nimport OSMXML from 'ol/format/OSMXML';\nimport { bbox as bboxStrategy } from 'ol/loadingstrategy';\nimport { toLonLat } from 'ol/proj';\nimport { useSelector, useDispatch } from 'react-redux'\nimport { addBuilding, removeBuilding } from '../redux/actions/buildingActions'\nimport proj4 from \"proj4\";\n\nconst VectorLayer = ({ defaultStyle, highlightStyle, renderZoom, centerSetter, zIndex = 1 }) => {\n\tconst { map } = useContext(MapContext);\n\tconst buildings = useSelector(state => state.buildings);\n\tconst dispatch = useDispatch();\n\n\tuseEffect(() => {\n\t\tif (!map) return;\n\n\t\tlet source = new VectorSource({\n\t\t\tformat: new OSMXML(),\n\t\t\tloader: function (extent, resolution, projection) {\n\t\t\t\tvar epsg4326Extent = transformExtent(extent, projection, 'EPSG:4326');\n\t\t\t\tvar client = new XMLHttpRequest();\n\t\t\t\tclient.open('POST', 'https://overpass-api.de/api/interpreter');\n\t\t\t\tclient.addEventListener('load', function () {\n\t\t\t\t\tvar features = new OSMXML().readFeatures(client.responseText, {\n\t\t\t\t\t\tfeatureProjection: map.getView().getProjection(),\n\t\t\t\t\t});\n\t\t\t\t\tsource.addFeatures(features);\n\t\t\t\t\treloadSelectedItems(source)\n\t\t\t\t});\n\t\t\t\tvar extended_load_percentage = 0.02;\n\t\t\t\tvar stringExtent = (epsg4326Extent[1] - epsg4326Extent[1] * extended_load_percentage) + ',' + (epsg4326Extent[0] * extended_load_percentage + epsg4326Extent[0]) + ',' +\n\t\t\t\t\t(epsg4326Extent[3] * extended_load_percentage + epsg4326Extent[3]) + ',' + (epsg4326Extent[2] - epsg4326Extent[2] * extended_load_percentage);\n\t\t\t\tvar query = \"(way[building](\" + stringExtent + \");); out meta; >; out meta qt;\"\n\t\t\t\tclient.send(query);\n\t\t\t},\n\t\t\tstrategy: bboxStrategy,\n\n\t\t});\n\n\t\tlet vectorLayer = new OLVectorLayer({\n\t\t\tsource: source,\n\t\t\tstyle: defaultStyle,\n\t\t\tminZoom: renderZoom\n\t\t});\n\t\tmap.addLayer(vectorLayer);\n\t\tvectorLayer.setZIndex(zIndex);\n\n\t\treturn () => {\n\t\t\tif (map) {\n\t\t\t\tmap.removeLayer(vectorLayer);\n\t\t\t}\n\t\t};\n\t}, [map]);\n\n\n\tuseEffect(() => {\n\t\tif (!map) return;\n\t\tmap.addEventListener('singleclick', modifyBuildingListListener);\n\t\treturn () => {\n\t\t\tif (map) {\n\t\t\t\tmap.removeEventListener('singleclick', modifyBuildingListListener);\n\t\t\t}\n\t\t};\n\t}, [map, buildings]);\n\n\tfunction reloadSelectedItems(source) {\n\t\tObject.keys(buildings).map((dictkey, index) => (\n\t\t\tsource.getFeatureById(getOriginalId(dictkey)).setStyle(highlightStyle)\n\t\t))\n\t}\n\n\tfunction getOriginalId(string) {\n\t\treturn string.replace(\"Building \", \"\")\n\t}\n\n\tfunction getPolygonCoordinates(coordinates) {\n\t\tvar newCoordinates = [];\n\t\tcoordinates.map(element => {\n\t\t\tdebugger;\n\t\t\tvar latloncoordinates = proj4('EPSG:3857', 'WGS84', [element[1], element[0]])\n\t\t\t//var latloncoordinates = [element[1], element[0]]\n\t\t\tnewCoordinates.push(latloncoordinates);\n\t\t})\n\t\treturn newCoordinates;\n\t}\n\n\tfunction modifyBuildingListListener(e) {\n\t\tmap.forEachFeatureAtPixel(e.pixel, function (f) {\n\t\t\tvar keys = Object.keys(buildings);\n\t\t\tvar buildingOlId = \"Building \" + f.getId();\n\t\t\tvar selIndex = keys.indexOf(buildingOlId);\n\t\t\tcenterSetter(toLonLat(map.getView().getCenter()));\n\t\t\tdebugger;\n\t\t\tif (selIndex < 0) {\n\t\t\t\tvar coordinates = f.getGeometry().getInteriorPoint().getCoordinates();\n\t\t\t\tvar lonLatCoordinates = toLonLat([coordinates[0], coordinates[1]]);\n\t\t\t\tvar latitude = lonLatCoordinates[0];\n\t\t\t\tvar longitude = lonLatCoordinates[1];\n\t\t\t\tvar area = getArea(f.getGeometry()).toFixed(2);\n\t\t\t\tvar polygonCoordinates = getPolygonCoordinates(f.getGeometry().getCoordinates()[0])\n\n\t\t\t\tdispatch(addBuilding(buildingOlId, latitude, longitude, area, polygonCoordinates));\n\t\t\t\tf.setStyle(highlightStyle);\n\t\t\t} else {\n\t\t\t\tdispatch(removeBuilding(buildingOlId));\n\t\t\t\tf.setStyle(defaultStyle);\n\n\t\t\t}\n\t\t});\n\n\t}\n\n\treturn null;\n};\n\n\nexport default VectorLayer;"]},"metadata":{},"sourceType":"module"}