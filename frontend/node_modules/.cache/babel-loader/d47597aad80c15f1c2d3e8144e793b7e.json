{"ast":null,"code":"import { useContext, useEffect } from \"react\";\nimport MapContext from \"../Map/MapContext\";\nimport OLVectorLayer from \"ol/layer/Vector\";\nimport { Vector as VectorSource } from 'ol/source';\nimport { transformExtent } from 'ol/proj';\nimport OSMXML from 'ol/format/OSMXML';\nimport { bbox as bboxStrategy } from 'ol/loadingstrategy';\nimport BuildingListContext from \"../BuildingMenu/BuildingListContext\";\nimport { Fill, Stroke, Style } from 'ol/style';\n\nconst VectorLayer = ({\n  zIndex = 1\n}) => {\n  const {\n    map\n  } = useContext(MapContext);\n  const [buildingList, setBuildingList] = useContext(BuildingListContext);\n  let styles = {\n    'Default': new Style({\n      stroke: new Stroke({\n        color: 'red',\n        width: 1\n      }),\n      fill: new Fill({\n        color: 'rgba(255, 242, 175, 0.5)'\n      })\n    }),\n    'BuildingHighlight': new Style({\n      fill: new Fill({\n        color: 'rgba(255,255,255,0.7)'\n      }),\n      stroke: new Stroke({\n        color: '#3399CC',\n        width: 3\n      })\n    })\n  };\n  useEffect(() => {\n    if (!map) return;\n    let source = new VectorSource({\n      format: new OSMXML(),\n      loader: function (extent, resolution, projection) {\n        var epsg4326Extent = transformExtent(extent, projection, 'EPSG:4326');\n        var client = new XMLHttpRequest();\n        client.open('POST', 'https://overpass-api.de/api/interpreter');\n        client.addEventListener('load', function () {\n          var features = new OSMXML().readFeatures(client.responseText, {\n            featureProjection: map.getView().getProjection()\n          });\n          source.addFeatures(features);\n        });\n        var extended_load_percentage = 0.02;\n        var stringExtent = epsg4326Extent[1] - epsg4326Extent[1] * extended_load_percentage + ',' + (epsg4326Extent[0] * extended_load_percentage + epsg4326Extent[0]) + ',' + (epsg4326Extent[3] * extended_load_percentage + epsg4326Extent[3]) + ',' + (epsg4326Extent[2] - epsg4326Extent[2] * extended_load_percentage);\n        var query = \"(way[building](\" + stringExtent + \");); out meta; >; out meta qt;\";\n        client.send(query);\n      },\n      strategy: bboxStrategy\n    });\n    let defaultStyle = styles.Default;\n    let vectorLayer = new OLVectorLayer({\n      source,\n      defaultStyle\n    });\n    map.on('singleclick', function (e) {\n      map.forEachFeatureAtPixel(e.pixel, function (f) {\n        var keys = Object.keys(buildingList);\n        var buildingOlId = f.ol_uid;\n        var selIndex = keys.indexOf(buildingOlId);\n\n        if (selIndex < 0) {\n          var buildingListClone = Object.assign({}, buildingList);\n          var latitude = f.getGeometry().getInteriorPoint().getCoordinates()[0];\n          var longitude = f.getGeometry().getInteriorPoint().getCoordinates()[1];\n          var area = f.getGeometry().getArea();\n          buildingListClone[buildingOlId] = {\n            'latitude': latitude,\n            'longitude': longitude,\n            'area': area\n          };\n        } else {}\n      });\n    });\n    map.addLayer(vectorLayer);\n    vectorLayer.setZIndex(zIndex);\n    return () => {\n      if (map) {\n        map.removeLayer(vectorLayer);\n      }\n    };\n  }, [map]);\n  return null;\n};\n\nexport default VectorLayer;","map":{"version":3,"sources":["/home/enrique/projects/prueba/src/Layers/VectorLayer.js"],"names":["useContext","useEffect","MapContext","OLVectorLayer","Vector","VectorSource","transformExtent","OSMXML","bbox","bboxStrategy","BuildingListContext","Fill","Stroke","Style","VectorLayer","zIndex","map","buildingList","setBuildingList","styles","stroke","color","width","fill","source","format","loader","extent","resolution","projection","epsg4326Extent","client","XMLHttpRequest","open","addEventListener","features","readFeatures","responseText","featureProjection","getView","getProjection","addFeatures","extended_load_percentage","stringExtent","query","send","strategy","defaultStyle","Default","vectorLayer","on","e","forEachFeatureAtPixel","pixel","f","keys","Object","buildingOlId","ol_uid","selIndex","indexOf","buildingListClone","assign","latitude","getGeometry","getInteriorPoint","getCoordinates","longitude","area","getArea","addLayer","setZIndex","removeLayer"],"mappings":"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","sourcesContent":["import { useContext, useEffect } from \"react\";\nimport MapContext from \"../Map/MapContext\";\nimport OLVectorLayer from \"ol/layer/Vector\";\nimport { Vector as VectorSource } from 'ol/source';\nimport { transformExtent } from 'ol/proj';\nimport OSMXML from 'ol/format/OSMXML';\nimport { bbox as bboxStrategy } from 'ol/loadingstrategy';\nimport BuildingListContext from \"../BuildingMenu/BuildingListContext\";\nimport { Fill, Stroke, Style } from 'ol/style';\n\nconst VectorLayer = ({ zIndex = 1 }) => {\n\tconst { map } = useContext(MapContext);\n\tconst [buildingList, setBuildingList] = useContext(BuildingListContext);\n\n\tlet styles = {\n\t\t'Default': new Style({\n\t\t\tstroke: new Stroke({\n\t\t\t\tcolor: 'red',\n\t\t\t\twidth: 1,\n\t\t\t}),\n\t\t\tfill: new Fill({\n\t\t\t\tcolor: 'rgba(255, 242, 175, 0.5)',\n\t\t\t}),\n\t\t}),\n\t\t'BuildingHighlight': new Style({\n\t\t\tfill: new Fill({\n\t\t\t\tcolor: 'rgba(255,255,255,0.7)',\n\t\t\t}),\n\t\t\tstroke: new Stroke({\n\t\t\t\tcolor: '#3399CC',\n\t\t\t\twidth: 3,\n\t\t\t}),\n\t\t}),\n\t};\n\n\tuseEffect(() => {\n\t\tif (!map) return;\n\n\t\tlet source = new VectorSource({\n\t\t\tformat: new OSMXML(),\n\t\t\tloader: function (extent, resolution, projection) {\n\t\t\t\tvar epsg4326Extent = transformExtent(extent, projection, 'EPSG:4326');\n\t\t\t\tvar client = new XMLHttpRequest();\n\t\t\t\tclient.open('POST', 'https://overpass-api.de/api/interpreter');\n\t\t\t\tclient.addEventListener('load', function () {\n\t\t\t\t\tvar features = new OSMXML().readFeatures(client.responseText, {\n\t\t\t\t\t\tfeatureProjection: map.getView().getProjection(),\n\t\t\t\t\t});\n\t\t\t\t\tsource.addFeatures(features);\n\t\t\t\t});\n\t\t\t\tvar extended_load_percentage = 0.02;\n\t\t\t\tvar stringExtent = (epsg4326Extent[1] - epsg4326Extent[1] * extended_load_percentage) + ',' + (epsg4326Extent[0] * extended_load_percentage + epsg4326Extent[0]) + ',' +\n\t\t\t\t\t(epsg4326Extent[3] * extended_load_percentage + epsg4326Extent[3]) + ',' + (epsg4326Extent[2] - epsg4326Extent[2] * extended_load_percentage);\n\t\t\t\tvar query = \"(way[building](\" + stringExtent + \");); out meta; >; out meta qt;\"\n\t\t\t\tclient.send(query);\n\t\t\t},\n\t\t\tstrategy: bboxStrategy,\n\n\t\t});\n\n\t\tlet defaultStyle = styles.Default;\n\n\t\tlet vectorLayer = new OLVectorLayer({\n\t\t\tsource,\n\t\t\tdefaultStyle\n\t\t});\n\n\n\t\tmap.on('singleclick', function (e) {\n\t\t\tmap.forEachFeatureAtPixel(e.pixel, function (f) {\n\t\t\t\tvar keys = Object.keys(buildingList);\n\t\t\t\tvar buildingOlId = f.ol_uid;\n\t\t\t\tvar selIndex = keys.indexOf(buildingOlId);\n\t\t\t\tif (selIndex < 0) {\n\t\t\t\t\tvar buildingListClone = Object.assign({}, buildingList);\n\t\t\t\t\tvar latitude = f.getGeometry().getInteriorPoint().getCoordinates()[0];\n\t\t\t\t\tvar longitude = f.getGeometry().getInteriorPoint().getCoordinates()[1];\n\t\t\t\t\tvar area = f.getGeometry().getArea();\n\t\t\t\t\tbuildingListClone[buildingOlId] = { 'latitude': latitude, 'longitude': longitude, 'area': area }\n\t\t\t\t} else {\n\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tmap.addLayer(vectorLayer);\n\t\tvectorLayer.setZIndex(zIndex);\n\n\t\treturn () => {\n\t\t\tif (map) {\n\t\t\t\tmap.removeLayer(vectorLayer);\n\t\t\t}\n\t\t};\n\t}, [map]);\n\n\treturn null;\n};\n\nexport default VectorLayer;"]},"metadata":{},"sourceType":"module"}